<!DOCTYPE html>
<html>
<head>
    <title>DBA Dashboard</title>
    <link rel="stylesheet" href="//cdn.webix.com/edge/webix.css">
    <script src="//cdn.webix.com/edge/webix.js"></script>
</head>
<body>
<script>
webix.ready(function() {
    // User Management Grid
    const userGrid = {
        view: "datatable",
        id: "userGrid",
        columns: [
            { id: "_id", header: "ID", hidden: true },
            { id: "username", header: "Username", fillspace: true },
            { id: "email", header: "Email", fillspace: true },
            { id: "role", header: "Role", fillspace: true },
            { 
                id: "active", 
                header: "Active", 
                template:"{common.checkbox()}", 
                width: 70,
                checkValue: true,
                uncheckValue: false
            },
            { 
                id: "created_at", 
                header: "Created At", 
                fillspace: true,
                format: webix.Date.dateToStr("%Y-%m-%d %H:%i")
            },
            { 
                id: "action", 
                header: "Actions", 
                width: 150,
                template: function(obj) {
                    const editBtn = "<button class='webix_button edit_btn'>Edit</button>";
                    const deleteBtn = obj.role !== "DBA" ? "<button class='webix_button delete_btn'>Delete</button>" : "";
                    return editBtn + " " + deleteBtn;
                }
            }
        ],
        select: true,
        url: "/api/users",
        on: {
            onCheck: function(rowId, colId, state) {
                if (colId === "active") {
                    const item = this.getItem(rowId);
                    if (item.role === "DBA" && !state) {
                        webix.message({
                            type: "error",
                            text: "Cannot deactivate DBA account"
                        });
                        return false;
                    }
                    
                    webix.ajax().put("/api/users/" + item._id, {
                        active: state
                    }).then(function(data) {
                        webix.message("User status updated");
                    }).fail(function(err) {
                        webix.message({
                            type: "error",
                            text: err.responseJSON.error
                        });
                    });
                }
            },
            onBeforeLoad: function() {
                this.showOverlay("Loading...");
            },
            onAfterLoad: function() {
                this.hideOverlay();
                if (!this.count()) {
                    this.showOverlay("No users found");
                }
            }
        },
        onClick: {
            edit_btn: function(e, id) {
                const item = this.getItem(id);
                showEditForm(item);
                return false;
            },
            delete_btn: function(e, id) {
                const item = this.getItem(id);
                if (item.role === "DBA") {
                    webix.message({
                        type: "error",
                        text: "Cannot delete DBA account"
                    });
                    return false;
                }
                deleteUser(item);
                return false;
            }
        }
    };

    // User Form
    const userForm = {
        view: "window",
        id: "userForm",
        width: 400,
        position: "center",
        modal: true,
        head: {
            view: "toolbar",
            cols: [
                { view: "label", label: "User Form", align: "center" },
                { 
                    view: "button", 
                    type: "icon", 
                    icon: "wxi-close",
                    width: 45, 
                    align: "right",
                    click: function() {
                        $$("userForm").hide();
                    }
                }
            ]
        },
        body: {
            view: "form",
            id: "userFormData",
            elements: [
                { view: "text", label: "Username", name: "username", required: true },
                { view: "text", type: "password", label: "Password", name: "password", required: true },
                { view: "text", type: "password", label: "Confirm Password", name: "confirm_password", required: true },
                { 
                    view: "select", 
                    label: "Role", 
                    name: "role",
                    options: ["Admin", "Vendor", "Finance"],
                    required: true 
                },
                { view: "text", label: "Email", name: "email", required: true },
                {
                    cols: [
                        { 
                            view: "button", 
                            value: "Save", 
                            css: "webix_primary", 
                            click: saveUser 
                        },
                        { 
                            view: "button", 
                            value: "Cancel",
                            click: function() {
                                $$("userForm").hide();
                            }
                        }
                    ]
                }
            ],
            rules: {
                $all: webix.rules.isNotEmpty,
                email: webix.rules.isEmail,
                confirm_password: function(value) {
                    return value === this.getValues().password;
                }
            }
        }
    };

    // Main Layout
    webix.ui({
        rows: [
            {
                view: "toolbar",
                padding: 3,
                elements: [
                    { view: "label", label: "DBA Dashboard" },
                    { 
                        view: "button", 
                        value: "Add User", 
                        width: 100,
                        click: showAddForm
                    },
                    { 
                        view: "button", 
                        value: "Logout", 
                        width: 100,
                        click: function() {
                            window.location.href = "/logout";
                        }
                    }
                ]
            },
            userGrid
        ]
    });

    // Create User Form Window
    webix.ui(userForm);

    // Functions
    function showAddForm() {
        $$("userFormData").clear();
        $$("userForm").getHead().getChildViews()[0].setValue("Add New User");
        $$("userForm").show();
    }

    function showEditForm(item) {
        const form = $$("userFormData");
        form.clear();
        form.setValues({
            _id: item._id,
            username: item.username,
            email: item.email,
            role: item.role
        });
        // Make password optional for edit
        form.getItem("password").define("required", false);
        form.getItem("confirm_password").define("required", false);
        form.refresh();
        
        $$("userForm").getHead().getChildViews()[0].setValue("Edit User");
        $$("userForm").show();
    }

    function saveUser() {
        const form = $$("userFormData");
        if (form.validate()) {
            const values = form.getValues();
            const isEdit = values._id;
            
            if (!isEdit && values.password !== values.confirm_password) {
                webix.message({ 
                    type: "error", 
                    text: "Passwords do not match" 
                });
                return;
            }

            if (isEdit) {
                // Update existing user
                webix.ajax().put("/api/users/" + values._id, values)
                    .then(function(data) {
                        $$("userGrid").reload();
                        $$("userForm").hide();
                        webix.message("User updated successfully");
                    })
                    .fail(function(err) {
                        webix.message({
                            type: "error",
                            text: err.responseJSON.error
                        });
                    });
            } else {
                // Create new user
                webix.ajax().post("/api/users", values)
                    .then(function(data) {
                        $$("userGrid").reload();
                        $$("userForm").hide();
                        webix.message("User created successfully");
                    })
                    .fail(function(err) {
                        webix.message({
                            type: "error",
                            text: err.responseJSON.error
                        });
                    });
            }
        }
    }

    function deleteUser(item) {
        webix.confirm({
            title: "Delete User",
            text: "Are you sure you want to delete this user?",
            callback: function(result) {
                if (result) {
                    webix.ajax().del("/api/users/" + item._id)
                        .then(function(data) {
                            $$("userGrid").reload();
                            webix.message("User deleted successfully");
                        })
                        .fail(function(err) {
                            webix.message({
                                type: "error",
                                text: err.responseJSON.error
                            });
                        });
                }
            }
        });
    }
});
</script>
</body>
</html>