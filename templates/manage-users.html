<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users</title>
</head>
<body>
    <a href="javascript:history.back()">Go Back</a>
    <h1>Manage Users</h1>
    <div id="content">
        <!-- Content will be loaded dynamically -->
    </div>
    <li><a href="/logout">Logout</a></li>

    <script>
        function loadUsers() {
            fetch('/api/users', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(users => {
                const content = document.getElementById('content');
                
                let html = `
                    <h2>User Management</h2>
                    <button id="addUserBtn" onclick="showAddUserForm()">Add New User</button>
                    <table border="1">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Active Status</th>
                                <th>Created At</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                fetch('/api/session-role', { credentials: 'include' })
                    .then(response => response.json())
                    .then(session => {
                        const currentRole = session.role;

                        users.forEach(user => {
                            const disableActions = currentRole === 'Admin' && user.role === 'DBA';
                            html += `
                                <tr>
                                    <td>${user.username}</td>
                                    <td>${user.email}</td>
                                    <td>${user.role}</td>
                                    <td>${user.active ? 'Active' : 'Inactive'}</td>
                                    <td>${user.created_at}</td>
                                    <td>${user.last_login || 'Haven\'t logged in'}</td>
                                    <td>
                                        <button 
                                            onclick="editUser('${user.username}')" 
                                            ${disableActions ? 'disabled' : ''}>Edit</button>
                                        <button 
                                            onclick="deleteUser('${user.username}')" 
                                            ${disableActions ? 'disabled' : ''}>Delete</button>
                                    </td>
                                </tr>
                            `;
                        });

                        html += `</tbody></table>`;
                        content.innerHTML = html;
                    });
                }
            )
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('content').innerHTML = `
                    <p style="color: red">Error loading users: ${error.message}</p>
                `;
            });
        }

        function showAddUserForm() {
            const content = document.getElementById('content');

            fetch('/api/session-role', { credentials: 'include' })
                .then(response => response.json())
                .then(session => {
                    const currentRole = session.role;
                    
                    const dbaOption = currentRole === 'Admin' 
                        ? '<option value="DBA" disabled>DBA (Not Allowed)</option>'
                        : '<option value="DBA">DBA</option>';

                    content.innerHTML = `
                        <h2>Add New User</h2>
                        <form id="addUserForm" onsubmit="submitNewUser(event)">
                            <div>
                                <label for="username">Username:</label>
                                <input type="text" id="username" name="username" required>
                            </div>
                            <div>
                                <label for="email">Email:</label>
                                <input type="email" id="email" name="email" required>
                            </div>
                            <div>
                                <label for="password">Password:</label>
                                <input type="password" id="password" name="password" required>
                            </div>
                            <div>
                                <label for="role">Role:</label>
                                <select id="role" name="role" required>
                                    ${dbaOption}
                                    <option value="Admin">Admin</option>
                                    <option value="Vendor">Vendor</option>
                                    <option value="Finance">Finance</option>
                                </select>
                            </div>
                            <button type="submit">Add User</button>
                            <button type="button" onclick="loadUsers()">Cancel</button>
                        </form>
                    `;
                })
                .catch(error => {
                    console.error('Error fetching session role:', error);
                    alert('Error fetching session role');
                });
        }

        function editUser(username) {
            fetch(`/api/users/${username}`, {
                method: 'GET',
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch user data');
                }
                return response.json();
            })
            .then(user => {
                const content = document.getElementById('content');

                fetch('/api/session-role', { credentials: 'include' })
                    .then(response => response.json())
                    .then(session => {
                        const currentRole = session.role;

                        if (currentRole === 'Admin' && user.role === 'DBA') {
                            alert('Admins cannot edit users with the DBA role.');
                            return;
                        }

                        content.innerHTML = `
                            <h2>Edit User: ${user.username}</h2>
                            <form id="editUserForm" onsubmit="submitEditUser(event, '${username}')">
                                <div>
                                    <label for="email">Email:</label>
                                    <input type="email" id="email" name="email" value="${user.email}" required>
                                </div>
                                <div>
                                    <label for="role">Role:</label>
                                    <select id="role" name="role" required>
                                        ${user.role === 'DBA' ? '<option value="DBA" selected disabled>DBA</option>' : ''}
                                        <option value="Admin" ${user.role === 'Admin' ? 'selected' : ''}>Admin</option>
                                        <option value="Vendor" ${user.role === 'Vendor' ? 'selected' : ''}>Vendor</option>
                                        <option value="Finance" ${user.role === 'Finance' ? 'selected' : ''}>Finance</option>
                                    </select>
                                </div>
                                <button type="submit">Save Changes</button>
                                <button type="button" onclick="loadUsers()">Cancel</button>
                            </form>
                        `;
                    });
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error fetching user data');
            });
        }

        function deleteUser(username) {
            fetch(`/api/users/${username}`, {
                method: 'GET',
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch user data');
                }
                return response.json();
            })
            .then(user => {
                fetch('/api/session-role', { credentials: 'include' })
                    .then(response => response.json())
                    .then(session => {
                        const currentRole = session.role;

                        if (currentRole === 'Admin' && user.role === 'DBA') {
                            alert('Admins cannot delete users with the DBA role.');
                            return;
                        }

                        if (confirm(`Are you sure you want to delete user ${username}?`)) {
                            fetch(`/api/users/${username}`, {
                                method: 'DELETE',
                                credentials: 'include'
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Failed to delete user');
                                }
                                alert('User deleted successfully');
                                loadUsers();
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('Error deleting user');
                            });
                        }
                    });
            });
        }

        function submitNewUser(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const userData = {
                username: formData.get('username'),
                password: formData.get('password'),
                role: formData.get('role'),
                email: formData.get('email')
            };

            fetch('/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(userData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Failed to add user');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('User added successfully');
                    loadUsers();
                } else {
                    throw new Error(data.error || 'Failed to add user');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`Error adding user: ${error.message}`);
            });
        }

        function submitEditUser(event, username) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const userData = {
                email: formData.get('email'),
                role: formData.get('role')
            };

            fetch(`/api/users/${username}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(userData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update user');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('User updated successfully');
                    loadUsers();
                } else {
                    throw new Error(data.error || 'Failed to update user');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`Error updating user: ${error.message}`);
            });
        }

        document.addEventListener('DOMContentLoaded', loadUsers);
    </script>
</body>
</html>
