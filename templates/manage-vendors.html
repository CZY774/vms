<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Vendors</title>
</head>
<body>
    <a href="javascript:history.back()">Go Back</a>
    <h1>Manage Vendors</h1>
    <div id="content">
        <!-- Content will be loaded dynamically -->
    </div>
    <li><a href="/logout">Logout</a></li>

    <script>
        function loadVendors() {
            fetch('/api/vendors', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
            })
            .then(response => response.json())
            .then(vendors => {
                const content = document.getElementById('content');
                const tableBody = vendors.map(vendor => `
                    <tr>
                        <td>${vendor.vendorId || ''}</td>
                        <td>${vendor.partnerType || ''}</td>
                        <td>${vendor.vendorName || ''}</td>
                        <td>${vendor.unitUsaha || ''}</td>
                        <td>${vendor.address || ''}</td>
                        <td>${vendor.country || ''}</td>
                        <td>${vendor.province || ''}</td>
                        <td>${vendor.noTelp || ''}</td>
                        <td>${vendor.emailCompany || ''}</td>
                        <td>${vendor.website || ''}</td>
                        <td>${vendor.namePIC || ''}</td>
                        <td>${vendor.noTelpPIC || ''}</td>
                        <td>${vendor.emailPIC || ''}</td>
                        <td>${vendor.positionPIC || ''}</td>
                        <td>${vendor.noNPWP || ''}</td>
                        <td>${vendor.activeStatus === 'Y' ? 'Active' : 'Inactive'}</td>
                        <td>
                            ${vendor.pic?.map(pic => `
                            <p>${pic.name || ''} (${pic.email || ''}, ${pic.noTelp || ''})</p>
                            `).join('') || ''}
                            </td>
                        <td>
                            ${vendor.supportingEquipment?.map(equipment => `
                                <p>${equipment.toolType || ''} - ${equipment.count || ''} (${equipment.merk || ''})</p>
                            `).join('') || ''}
                        </td>
                        <td>
                            ${vendor.branchOffice?.map(branch => `
                                <p>${branch.branchName || ''} - ${branch.location || ''}</p>
                            `).join('') || ''}
                        </td>
                        <td>
                            ${vendor.accountBank?.map(account => `
                                <p>${account.bankName || ''} - ${account.accountNumber || ''}</p>
                                `).join('') || ''}
                        </td>
                        <td>${vendor.change?.createDate || ''}</td>
                        <td>${vendor.change?.createUser || ''}</td>
                        <td>${vendor.change?.updateDate || ''}</td>
                        <td>${vendor.change?.updateUser || ''}</td>
                        <td>
                            <button onclick="editVendor('${vendor._id}')">Edit</button>
                            <button onclick="deleteVendor('${vendor._id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');

                content.innerHTML = `
                    <h2>Vendor Management</h2>
                    <button onclick="showAddVendorForm()">Add New Vendor</button>
                    <table border="1">
                        <thead>
                            <tr>
                                <th>Vendor ID</th>
                                <th>Partner Type</th>
                                <th>Vendor Name</th>
                                <th>Unit Usaha</th>
                                <th>Address</th>
                                <th>Country</th>
                                <th>Province</th>
                                <th>Phone</th>
                                <th>Email</th>
                                <th>Website</th>
                                <th>Name PIC</th>
                                <th>Phone PIC</th>
                                <th>Email PIC</th>
                                <th>Position PIC</th>
                                <th>NPWP</th>
                                <th>Active Status</th>
                                <th>PIC</th>
                                <th>Supporting Equipment</th>
                                <th>Branch Offices</th>
                                <th>Account Bank</th>
                                <th>Create Date</th>
                                <th>Create User</th>
                                <th>Update Date</th>
                                <th>Update User</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>${tableBody}</tbody>
                    </table>
                `;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('content').innerHTML = `
                    <p style="color: red">Error loading vendors: ${error.message}</p>
                `;
            });
        }

        function showAddVendorForm() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <h2>Add New Vendor</h2>
                <form id="addVendorForm" onsubmit="submitNewVendor(event)">
                    <div>
                        <label for="vendor_code">Vendor Code:</label>
                        <input type="text" id="vendor_code" name="_id" required>
                    </div>
                    <div>
                        <label for="vendorName">Vendor Name:</label>
                        <input type="text" id="vendorName" name="vendorName" required><br>
                    </div>
                    <div>
                        <label for="unitUsaha">Unit Usaha:</label>
                        <input type="text" id="unitUsaha" name="unitUsaha"><br>
                    </div>
                    <div>
                        <label for="address">Address:</label>
                        <input type="text" id="address" name="address" required><br>
                    </div>
                    <div id="dynamicFields">
                        <h3>Account Banks</h3>
                        <div id="accountBankFields"></div>
                        <button type="button" onclick="addAccountBank()">Add Account Bank</button>
                        <h3>Supporting Equipment</h3>
                        <div id="equipmentFields"></div>
                        <button type="button" onclick="addSupportingEquipment()">Add Equipment</button>
                        <h3>Branch Office</h3>
                        <div id="branchOfficeFields"></div>
                        <button type="button" onclick="addBranchOffice()">Add Branch Office</button>
                        <h3>PIC</h3>
                        <div id="picFields"></div>
                        <button type="button" onclick="addPIC()">Add PIC</button>
                    </div>
                    <button type="submit">Save</button>
                </form>
            `;
        }

        function addAccountBank() {
            const container = document.getElementById('accountBankFields');
            if (container) {
                container.insertAdjacentHTML('beforeend', `
                    <div>
                        <label>Bank Code:</label>
                        <input type="text" name="accountBank_bankCode[]" required>
                        <label>Bank Name:</label>
                        <input type="text" name="accountBank_bankName[]" required>
                        <label>Account Number:</label>
                        <input type="text" name="accountBank_accountNumber[]" required>
                        <label>Account Name:</label>
                        <input type="text" name="accountBank_accountName[]" required>
                        <button type="button" onclick="this.parentElement.remove()">Remove</button>
                    </div>
                `);
            }
        }

        function addSupportingEquipment() {
            const container = document.getElementById('equipmentFields');
            if (container) {
                container.insertAdjacentHTML('beforeend', `
                    <div>
                        <label>Tool Type:</label>
                        <input type="text" name="supportingEquipment_toolType[]" required>
                        <label>Count:</label>
                        <input type="number" name="supportingEquipment_count[]" required>
                        <label>Merk:</label>
                        <input type="text" name="supportingEquipment_merk[]" required>
                        <button type="button" onclick="this.parentElement.remove()">Remove</button>
                    </div>
                `);
            }
        }

        function addBranchOffice() {
            const container = document.getElementById('branchOfficeFields');
            if (container) {
                container.insertAdjacentHTML('beforeend', `
                    <div>
                        <label>Branch Name:</label>
                        <input type="text" name="branchOffice_branchName[]" required>
                        <label>Location:</label>
                        <input type="text" name="branchOffice_location[]" required>
                        <button type="button" onclick="this.parentElement.remove()">Remove</button>
                    </div>
                `);
            }
        }

        function addPIC() {
            const container = document.getElementById('picFields');
            if (container) {
                container.insertAdjacentHTML('beforeend', `
                    <div>
                        <label>Name:</label>
                        <input type="text" name="pic_name[]" required>
                        <label>Email:</label>
                        <input type="email" name="pic_email[]" required>
                        <button type="button" onclick="this.parentElement.remove()">Remove</button>
                    </div>
                `);
            }
        }

        function submitNewVendor(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const vendorData = Object.fromEntries(formData.entries());

            // Handle nested fields (arrays)
            vendorData.accountBank = formData.getAll('accountBank_bankCode').map((_, i) => ({
                bankCode: formData.getAll('accountBank_bankCode')[i],
                bankName: formData.getAll('accountBank_bankName')[i],
                accountNumber: formData.getAll('accountBank_accountNumber')[i],
                accountName: formData.getAll('accountBank_accountName')[i],
            }));

            vendorData.supportingEquipment = formData.getAll('supportingEquipment_toolType').map((_, i) => ({
                toolType: formData.getAll('supportingEquipment_toolType')[i],
                count: formData.getAll('supportingEquipment_count')[i],
                merk: formData.getAll('supportingEquipment_merk')[i],
            }));

            vendorData.branchOffice = formData.getAll('branchOffice_branchName').map((_, i) => ({
                branchName: formData.getAll('branchOffice_branchName')[i],
                location: formData.getAll('branchOffice_location')[i],
            }));

            vendorData.pic = formData.getAll('pic_name').map((_, i) => ({
                name: formData.getAll('pic_name')[i],
                email: formData.getAll('pic_email')[i],
            }));

            fetch('/api/vendors', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(vendorData),
            })
            .then(response => response.json())
            .then(data => {
                alert('Vendor added successfully');
                loadVendors();
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`Error adding vendor: ${error.message}`);
            });
        }

        function editVendor(vendorId) {
            fetch(`/api/vendors/${vendorId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to fetch vendor details for ID: ${vendorId}`);
                }
                return response.json();
            })
            .then(vendor => {
                showEditVendorForm(vendor);
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`Error fetching vendor details: ${error.message}`);
            });
        }

        function showEditVendorForm(vendor) {
            const content = document.getElementById('content');
            const supportingEquipmentRows = (vendor.supportingEquipment || []).map(equipment => `
                <div>
                    <label>Tool Type:</label>
                    <input type="text" name="supportingEquipment_toolType[]" value="${equipment.toolType || ''}">
                    <label>Count:</label>
                    <input type="number" name="supportingEquipment_count[]" value="${equipment.count || ''}">
                    <label>Merk:</label>
                    <input type="text" name="supportingEquipment_merk[]" value="${equipment.merk || ''}">
                    <label>Condition:</label>
                    <input type="text" name="supportingEquipment_condition[]" value="${equipment.condition || ''}">
                </div>
            `).join('');

            const branchOfficeRows = (vendor.branchOffice || []).map(branch => `
                <div>
                    <label>Branch Name:</label>
                    <input type="text" name="branchOffice_branchName[]" value="${branch.branchName || ''}">
                    <label>Location:</label>
                    <input type="text" name="branchOffice_location[]" value="${branch.location || ''}">
                    <label>Address:</label>
                    <input type="text" name="branchOffice_address[]" value="${branch.address || ''}">
                    <label>Country:</label>
                    <input type="text" name="branchOffice_country[]" value="${branch.country || ''}">
                    <label>Phone:</label>
                    <input type="text" name="branchOffice_noTelp[]" value="${branch.noTelp || ''}">
                    <label>Website:</label>
                    <input type="text" name="branchOffice_website[]" value="${branch.website || ''}">
                    <label>Email:</label>
                    <input type="email" name="branchOffice_email[]" value="${branch.email || ''}">
                </div>
            `).join('');

            const picRows = (vendor.pic || []).map(pic => `
                <div>
                    <label>Username:</label>
                    <input type="text" name="pic_username[]" value="${pic.username || ''}">
                    <label>Name:</label>
                    <input type="text" name="pic_name[]" value="${pic.name || ''}">
                    <label>Email:</label>
                    <input type="email" name="pic_email[]" value="${pic.email || ''}">
                    <label>Phone:</label>
                    <input type="text" name="pic_noTelp[]" value="${pic.noTelp || ''}">
                </div>
            `).join('');

            const accountBankRows = (vendor.accountBank || []).map(account => `
                <div>
                    <label>Bank Code:</label>
                    <input type="text" name="accountBank_bankCode[]" value="${account.bankCode || ''}">
                    <label>Bank Name:</label>
                    <input type="text" name="accountBank_bankName[]" value="${account.bankName || ''}">
                    <label>Account Number:</label>
                    <input type="text" name="accountBank_accountNumber[]" value="${account.accountNumber || ''}">
                    <label>Account Name:</label>
                    <input type="text" name="accountBank_accountName[]" value="${account.accountName || ''}">
                </div>
            `).join('');

            content.innerHTML = `
                <h2>Edit Vendor</h2>
                <form id="editVendorForm" onsubmit="submitEditVendor(event, '${vendor._id}')">
                    <div>
                        <label>Partner Type:</label>
                        <input type="text" name="partnerType" value="${vendor.partnerType || ''}">
                    </div>
                    <div>
                        <label>Vendor Name:</label>
                        <input type="text" name="vendorName" value="${vendor.vendorName || ''}">
                    </div>
                    <div>
                        <label>Unit Usaha:</label>
                        <input type="text" name="unitUsaha" value="${vendor.unitUsaha || ''}">
                    </div>
                    <div>
                        <label>Address:</label>
                        <input type="text" name="address" value="${vendor.address || ''}">
                    </div>
                    <div>
                        <label>Country:</label>
                        <input type="text" name="country" value="${vendor.country || ''}">
                    </div>
                    <div>
                        <label>Province:</label>
                        <input type="text" name="province" value="${vendor.province || ''}">
                    </div>
                    <div>
                        <label>Phone:</label>
                        <input type="text" name="noTelp" value="${vendor.noTelp || ''}">
                    </div>
                    <div>
                        <label>Email:</label>
                        <input type="email" name="emailCompany" value="${vendor.emailCompany || ''}">
                    </div>
                    <div>
                        <label>Website:</label>
                        <input type="text" name="website" value="${vendor.website || ''}">
                    </div>
                    <div>
                        <label>Name PIC:</label>
                        <input type="text" name="namePIC" value="${vendor.namePIC || ''}">
                    </div>
                    <div>
                        <label>Phone PIC:</label>
                        <input type="text" name="noTelpPIC" value="${vendor.noTelpPIC || ''}">
                    </div>
                    <div>
                        <label>Email PIC:</label>
                        <input type="email" name="emailPIC" value="${vendor.emailPIC || ''}">
                    </div>
                    <div>
                        <label>Position PIC:</label>
                        <input type="text" name="positionPIC" value="${vendor.positionPIC || ''}">
                    </div>
                    <div>
                        <label>NPWP:</label>
                        <input type="text" name="noNPWP" value="${vendor.noNPWP || ''}">
                    </div>
                    <div>
                        <label>Active Status:</label>
                        <input type="checkbox" name="activeStatus" ${vendor.activeStatus ? 'checked' : ''}>
                    </div>
                    <div>
                        <h3>Supporting Equipment</h3>
                        <div id="equipmentFields">
                            ${(vendor.supportingEquipment || []).map(equipment => `
                                <div>
                                    <label>Tool Type:</label>
                                    <input type="text" name="supportingEquipment_toolType[]" value="${equipment.toolType || ''}">
                                    <label>Count:</label>
                                    <input type="number" name="supportingEquipment_count[]" value="${equipment.count || ''}">
                                    <label>Merk:</label>
                                    <input type="text" name="supportingEquipment_merk[]" value="${equipment.merk || ''}">
                                    <button type="button" onclick="this.parentElement.remove()">Remove</button>
                                </div>
                            `).join('')}
                        </div>
                        <button type="button" onclick="addSupportingEquipment()">Add Equipment</button>
                    </div>
                    <div>
                        <h3>Branch Office</h3>
                        <div id="branchOfficeFields">
                            ${(vendor.branchOffice || []).map(branch => `
                                <div>
                                    <label>Branch Name:</label>
                                    <input type="text" name="branchOffice_branchName[]" value="${branch.branchName || ''}">
                                    <label>Location:</label>
                                    <input type="text" name="branchOffice_location[]" value="${branch.location || ''}">
                                    <button type="button" onclick="this.parentElement.remove()">Remove</button>
                                </div>
                            `).join('')}
                        </div>
                        <button type="button" onclick="addBranchOffice()">Add Branch Office</button>
                    </div>
                    <div>
                        <h3>PIC</h3>
                        <div id="picFields">
                            ${(vendor.pic || []).map(pic => `
                                <div>
                                    <label>Name:</label>
                                    <input type="text" name="pic_name[]" value="${pic.name || ''}">
                                    <label>Email:</label>
                                    <input type="email" name="pic_email[]" value="${pic.email || ''}">
                                    <button type="button" onclick="this.parentElement.remove()">Remove</button>
                                </div>
                            `).join('')}
                        </div>
                        <button type="button" onclick="addPIC()">Add PIC</button>
                    </div>
                    <div>
                        <h3>Account Bank</h3>
                        <div id="accountBankFields">
                            ${(vendor.accountBank || []).map(account => `
                                <div>
                                    <label>Bank Code:</label>
                                    <input type="text" name="accountBank_bankCode[]" value="${account.bankCode || ''}">
                                    <label>Bank Name:</label>
                                    <input type="text" name="accountBank_bankName[]" value="${account.bankName || ''}">
                                    <label>Account Number:</label>
                                    <input type="text" name="accountBank_accountNumber[]" value="${account.accountNumber || ''}">
                                    <button type="button" onclick="this.parentElement.remove()">Remove</button>
                                </div>
                            `).join('')}
                        </div>
                        <button type="button" onclick="addAccountBank()">Add Account Bank</button>
                    </div>
                    <button type="submit">Save</button>
                    <button type="button" onclick="loadVendors()">Cancel</button>
                </form>
            `;
        }

        function submitEditVendor(event, vendorId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const vendorData = Object.fromEntries(formData.entries());

            vendorData.activeStatus = vendorData.activeStatus === 'on';

            fetch(`/api/vendors/${vendorId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(vendorData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update vendor');
                }
                return response.json();
            })
            .then(data => {
                alert('Vendor updated successfully');
                loadVendors();
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`Error updating vendor: ${error.message}`);
            });
        }

        function deleteVendor(vendorId) {
            if (!confirm('Are you sure you want to delete this vendor?')) {
                return;
            }

            fetch(`/api/vendors/${vendorId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete vendor');
                }
                return response.json();
            })
            .then(data => {
                alert('Vendor deleted successfully');
                loadVendors();
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`Error deleting vendor: ${error.message}`);
            });
        }

        document.addEventListener('DOMContentLoaded', loadVendors);
    </script>
</body>
</html>
