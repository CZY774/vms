<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Banks</title>
</head>
<body>
    <li><a href="javascript:history.back()">Go Back</a></li>
    <h1>Manage Banks</h1>
    <div id="content">
        <!-- Content will be loaded dynamically -->
    </div>
    <li><a href="/logout">Logout</a></li>

    <script>
        function loadBanks() {
            fetch('/api/banks', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch banks');
                }
                return response.json();
            })
            .then(banks => {
                const content = document.getElementById('content');
                let html = `
                    <h2>Bank Management</h2>
                    <button onclick="showAddBankForm()">Add New Bank</button>
                    <table border="1">
                        <thead>
                            <tr>
                                <th>Bank Code</th>
                                <th>Description</th>
                                <th>Active Status</th>
                                <th>Create Date</th>
                                <th>Create User</th>
                                <th>Update Date</th>
                                <th>Update User</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                banks.forEach(bank => {
                    const setup = bank.setup || {}; // Pastikan setup tidak undefined
                    html += `
                        <tr>
                            <td>${bank._id}</td>
                            <td>${bank.bankDesc || 'No description'}</td>
                            <td>${bank.activeStatus === 'Y' ? 'Active' : 'Inactive'}</td>
                            <td>${setup.createDate || 'No data'}</td>
                            <td>${setup.createUser || 'No data'}</td>
                            <td>${setup.updateDate || 'No data'}</td>
                            <td>${setup.updateUser || 'No data'}</td>
                            <td>
                                <button onclick="editBank('${bank._id}')">Edit</button>
                                <button onclick="deleteBank('${bank._id}')">Delete</button>
                            </td>
                        </tr>
                    `;
                });


                html += `
                        </tbody>
                    </table>
                `;

                content.innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('content').innerHTML = `
                    <p style="color: red">Error loading banks: ${error.message}</p>
                `;
            });
        }

        function showAddBankForm() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <h2>Add New Bank</h2>
                <form id="addBankForm" onsubmit="submitNewBank(event)">
                    <div>
                        <label for="bank_code">Bank Code:</label>
                        <input type="text" id="bank_code" name="_id" required>
                    </div>
                    <div>
                        <label for="bank_desc">Description:</label>
                        <textarea id="bank_desc" name="bankDesc" rows="4" required></textarea>
                    </div>
                    <button type="submit">Add Bank</button>
                    <button type="button" onclick="loadBanks()">Cancel</button>
                </form>
            `;
        }

        function submitNewBank(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const bankData = Object.fromEntries(formData.entries());

            fetch('/api/banks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(bankData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to add bank');
                }
                return response.json();
            })
            .then(data => {
                alert('Bank added successfully');
                loadBanks();
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`Error adding bank: ${error.message}`);
            });
        }

        function editBank(bankId) {
            fetch(`/api/banks/${bankId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || `Failed to fetch details for bank ID: ${bankId}`);
                    });
                }
                return response.json();
            })
            .then(bank => {
                showEditBankForm(bank);
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`Error fetching bank details: ${error.message}`);
            });
        }

        function showEditBankForm(bank) {
            const content = document.getElementById('content');
            content.innerHTML = `
                <h2>Edit Bank</h2>
                <form id="editBankForm" onsubmit="submitEditBank(event, '${bank._id}')">
                    <div>
                        <label for="bank_code">Bank Code:</label>
                        <input type="text" id="bank_code" value="${bank._id}" disabled>
                    </div>
                    <div>
                        <label for="bank_desc">Description:</label>
                        <textarea id="bank_desc" name="bankDesc" rows="4" required>${bank.bankDesc || ''}</textarea>
                    </div>
                    <div>
                        <label for="active_status">Active Status:</label>
                        <select id="active_status" name="activeStatus">
                            <option value="Y" ${bank.activeStatus === 'Y' ? 'selected' : ''}>Active</option>
                            <option value="N" ${bank.activeStatus === 'N' ? 'selected' : ''}>Inactive</option>
                        </select>
                    </div>
                    <button type="submit">Update Bank</button>
                    <button type="button" onclick="loadBanks()">Cancel</button>
                </form>
            `;
        }

        function submitEditBank(event, bankId) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const bankData = Object.fromEntries(formData.entries());

            fetch(`/api/banks/${bankId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(bankData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to update bank');
                }
                return response.json();
            })
            .then(data => {
                alert('Bank updated successfully');
                loadBanks();
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`Error updating bank: ${error.message}`);
            });
        }

        function deleteBank(bankId) {
            if (!confirm('Are you sure you want to delete this bank?')) {
                return;
            }

            fetch(`/api/banks/${bankId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete bank');
                }
                return response.json();
            })
            .then(data => {
                alert('Bank deleted successfully');
                loadBanks();
            })
            .catch(error => {
                console.error('Error:', error);
                alert(`Error deleting bank: ${error.message}`);
            });
        }

        document.addEventListener('DOMContentLoaded', loadBanks);
    </script>
</body>
</html>
